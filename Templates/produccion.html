{% extends "base.html" %}
{% load static %}

{% block title %}Registrar Producción | Panadería J&J{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{% static 'produccion.css' %}">
    
    <header class="header">
        <h1><i class="bi bi-gear-fill"></i> Registro de Producción</h1>
    </header>

    <section class="produccion-area">
        <div class="card produccion-form-card">
            
            <form method="post" action="{% url 'produccion' %}">
                {% csrf_token %}

                <div class="form-group">
                    <label for="producto_a_producir">Producto a Fabricar:</label>
                    <select id="producto_a_producir" name="producto_id" required onchange="loadRecipe()">
                        <option value="">--- Seleccione Producto ---</option>
                        {% for p in productos_pan %}
                            {# construimos data-recipe con los insumos del producto usando ProductoInsumo relacionado #}
                            <option value="{{ p.id }}" data-recipe='[
                                {% for pi in p.productoinsumo_set.all %}
                                    {"insumo":"{{ pi.insumo.nombre|escapejs }}","cantidad_utilizada":"{{ pi.cantidad_utilizada }}"}{% if not forloop.last %},{% endif %}
                                {% endfor %}
                            ]'>{{ p.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="cantidad_a_producir">Cantidad a Producir (Unidades):</label>
                    <input type="number" id="cantidad_a_producir" name="cantidad" placeholder="Cantidad" min="1" required value="1" oninput="calculateInsumos()">
                </div>
                
                <div class="form-group">
                    <label for="fecha_produccion">Fecha y Hora de Inicio:</label>
                    <input type="datetime-local" id="fecha_produccion" name="fecha_hora" required value="{{ 'now'|date:'Y-m-d\TH:i' }}">
                </div>

                <h3 class="insumo-header">Insumos Requeridos por el Lote:</h3>
                <div id="insumos-requeridos" class="insumos-container">
                    <p class="text-muted">Seleccione un producto y la cantidad para ver los insumos necesarios.</p>
                </div>
                
                <button type="submit" class="submit-produccion-btn" id="submit-btn" disabled>
                    <i class="bi bi-fire"></i> Iniciar Producción
                </button>
            </form>
            
        </div>
    </section>

    <script>
        function loadRecipe() {
            const select = document.getElementById('producto_a_producir');
            const selected = select.options[select.selectedIndex];
            const recipe = selected ? selected.getAttribute('data-recipe') : null;
            if (recipe) {
                select.setAttribute('data-current-recipe', recipe);
            } else {
                select.removeAttribute('data-current-recipe');
            }
            calculateInsumos();
        }

        function calculateInsumos() {
            const select = document.getElementById('producto_a_producir');
            const cantidadInput = document.getElementById('cantidad_a_producir');
            const insumosDiv = document.getElementById('insumos-requeridos');
            const submitBtn = document.getElementById('submit-btn');

            const cantidadLote = parseInt(cantidadInput.value) || 0;
            const recipeStr = select.getAttribute('data-current-recipe');

            insumosDiv.innerHTML = '';
            submitBtn.disabled = true;

            if (cantidadLote > 0 && recipeStr) {
                try {
                    const receta = JSON.parse(recipeStr);
                    if (!receta.length) {
                        insumosDiv.innerHTML = '<p class="text-muted">No hay insumos definidos para este producto.</p>';
                        return;
                    }

                    let html = '<ul class="insumos-list">';
                    receta.forEach(item => {
                        const uso = parseFloat(item.cantidad_utilizada) || 0;
                        const totalUso = uso * cantidadLote;
                        html += `
                            <li>
                                <span class="insumo-name">${item.insumo}:</span>
                                <span class="insumo-qty">${totalUso.toFixed(2)}</span>
                            </li>
                        `;
                    });
                    html += '</ul><div class="alert-info">⚠️ Esta es la cantidad total de insumos que se consumirá del inventario al producir este lote.</div>';
                    insumosDiv.innerHTML = html;
                    submitBtn.disabled = false;
                } catch (e) {
                    console.error('Error parseando receta:', e);
                    insumosDiv.innerHTML = '<p class="text-error">Error al cargar la receta. Verifique la selección.</p>';
                }
            } else if (select.value) {
                insumosDiv.innerHTML = '<p class="text-muted">Ingrese una cantidad válida mayor a 0.</p>';
            } else {
                insumosDiv.innerHTML = '<p class="text-muted">Seleccione un producto y la cantidad para ver los insumos necesarios.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // inic.
            loadRecipe();
        });
    </script>
{% endblock %}