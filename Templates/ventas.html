{% extends "base.html" %}
{% load static %}

{% block title %}Registrar Venta | Panadería J&J{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{% static 'ventas.css' %}">

    <header class="header">
        <div class="header-title">
            <h1>Registrar Nueva Venta</h1>
        </div>
    </header>

    <section class="venta-area">
        <div class="card venta-form-card">
            <h2>Registrar Venta</h2>
            
            <form method="post" action="{% url 'ventas' %}">
                {% csrf_token %}

                <div class="form-group">
                    <label for="vendedor">Vendedor:</label>
                    <select id="vendedor" name="vendedor" required>
                        <option value="">--- Seleccione Vendedor ---</option>
                        {% for v in vendedores %}
                            <option value="{{ v.id }}">{{ v.nombre }}</option>
                        {% empty %}
                            <option value="">No hay vendedores</option>
                        {% endfor %}
                    </select>
                </div>
                
                <h3>Detalles del Pedido:</h3>

                <template id="producto-options">
                    <option value="">--- Seleccione Producto ---</option>
                    {% for p in productos %}
                        <option value="{{ p.id }}" data-precio="{{ p.precio_venta }}">{{ p.nombre }} (C${{ p.precio_venta }})</option>
                    {% endfor %}
                </template>

                <div id="productos-container">
                    <div class="producto-row">
                        <select name="producto_id" required>
                            {% for p in productos %}
                                <option value="{{ p.id }}" data-precio="{{ p.precio_venta }}">{{ p.nombre }} (C${{ p.precio_venta }})</option>
                            {% empty %}
                                <option value="">No hay productos</option>
                            {% endfor %}
                        </select>
                        <input type="number" name="cantidad" placeholder="Cantidad" min="1" required class="cantidad-input" value="1">
                        <span class="subtotal-display">C$0.00</span>
                        <button type="button" class="remove-product-btn" onclick="removeProductRow(this)">X</button>
                    </div>
                </div>

                <button type="button" id="add-product-btn" class="add-product-btn">
                    <i class="bi bi-plus-square-fill"></i> Agregar Otro Producto
                </button>

                <div class="venta-summary">
                    <div class="total-label">TOTAL A PAGAR:</div>
                    <div id="total-venta" class="total-value">C$0.00</div>
                </div>

                <button type="submit" class="submit-venta-btn">
                    <i class="bi bi-credit-card-fill"></i> Finalizar Transacción
                </button>
            </form>
        </div>
    </section>

    <script>
        const container = document.getElementById('productos-container');
        const addBtn = document.getElementById('add-product-btn');
        const totalDisplay = document.getElementById('total-venta');

        // Guardar opciones generadas por el servidor para usar al añadir filas
        document.addEventListener('DOMContentLoaded', () => {
            window.productOptionsHTML = document.getElementById('producto-options') ? document.getElementById('producto-options').innerHTML : '';
            // Inicializar listeners de fila existente y calcular total
            container.querySelectorAll('.producto-row').forEach(attachRowListeners);
            calculateTotal();
        });

        // Crear plantilla de fila usando las opciones del servidor
        function createProductRowHTML() {
            const options = window.productOptionsHTML || '<option value="">No hay productos</option>';
            return `
                <div class="producto-row">
                    <select name="producto_id" required>
                        ${options}
                    </select>
                    <input type="number" name="cantidad" placeholder="Cantidad" min="1" required class="cantidad-input" value="1">
                    <span class="subtotal-display">C$0.00</span>
                    <button type="button" class="remove-product-btn" onclick="removeProductRow(this)">X</button>
                </div>
            `;
        }

        addBtn.addEventListener('click', () => {
            container.insertAdjacentHTML('beforeend', createProductRowHTML());
            const newRow = container.lastElementChild;
            attachRowListeners(newRow);
            calculateTotal();
        });

        window.removeProductRow = function(button) {
            if (container.querySelectorAll('.producto-row').length > 1) {
                button.closest('.producto-row').remove();
                calculateTotal();
            } else {
                alert("Debe haber al menos un producto en la venta.");
            }
        };

        function calculateRowTotal(row) {
            const select = row.querySelector('select[name="producto_id"]');
            const input = row.querySelector('input[name="cantidad"]');
            const subtotalDisplay = row.querySelector('.subtotal-display');

            const selectedOption = select.options[select.selectedIndex];
            const price = parseFloat(selectedOption?.getAttribute('data-precio')) || 0.00;
            const quantity = parseInt(input.value) || 0;
            
            const subtotal = price * quantity;
            subtotalDisplay.textContent = `C$${subtotal.toFixed(2)}`;
            
            return subtotal;
        }

        function calculateTotal() {
            let grandTotal = 0;
            const rows = container.querySelectorAll('.producto-row');
            rows.forEach(row => {
                grandTotal += calculateRowTotal(row);
            });
            totalDisplay.textContent = `C$${grandTotal.toFixed(2)}`;
        }

        function attachRowListeners(row) {
            const select = row.querySelector('select[name="producto_id"]');
            const input = row.querySelector('input[name="cantidad"]');
            if (select) select.addEventListener('change', () => { calculateRowTotal(row); calculateTotal(); });
            if (input) {
                input.addEventListener('input', () => { calculateRowTotal(row); calculateTotal(); });
                input.addEventListener('change', () => { calculateRowTotal(row); calculateTotal(); });
            }
            // calcular subtotal inicial para la fila
            calculateRowTotal(row);
        }
    </script>
{% endblock %}